<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Book Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div>
        <canvas id="bidsChart" width="400" height="200"></canvas>
    </div>
    <div>
        <canvas id="asksChart" width="400" height="200"></canvas>
    </div>
    <div style="width: 30%; margin: 0px auto;">
        <canvas id="myPieChart" width="400" height="200"></canvas>
    </div>
    <script>

        let bidsData = {};
        let asksData = {};
        let labels = [];

        document.addEventListener('DOMContentLoaded', function() {
            const bidsCtx = document.getElementById('bidsChart').getContext('2d');
            const ctx = document.getElementById('myPieChart').getContext('2d');

            // Khởi tạo biểu đồ Chart.js cho Bids
            const bidsChart = new Chart(bidsCtx, {
                type: 'bar',
                data: {
                    labels: [],  // The x-axis labels (price)
                    datasets: [
                        {
                            label: 'Bids',
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            data: []  // Data for buy orders
                        },
                        {
                            label: 'Asks',
                            backgroundColor: 'red',
                            data: []  //Data for sell orders
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Price'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Quantity'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const quantity = context.raw;
                                    return `Quantity: ${quantity}`;
                                }
                            }
                        }
                    }
                }
            });

           // Initialize Chart.js chart for Pie Chart
            const myPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Asks', 'Bids'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#FF6384', '#36A2EB'],
                        hoverBackgroundColor: ['#FF6384', '#36A2EB']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return tooltipItem.label + ': ' + tooltipItem.raw;
                                }
                            }
                        }
                    }
                }
            });
            const today = new Date();

            /// Get the components of the current date
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); //Add leading zero if needed
            const day = String(today.getDate()).padStart(2, '0'); //Add leading zero if needed

           // Format current date in YYYY-MM-DD format
            const formattedDate = `${year}-${month}-${day}`;

            // Full path to CSV file
            const csvFilePath = `csv/future_order_book_btcusdt_${formattedDate}.csv`;

            // Full path to CSV file
            const addedEntries = new Set();

            // Function to load data and update chart
            let totalBids = 0;
            let totalAsks = 0;
            function loadDataAndVisualize() {
                fetch(csvFilePath)
                    .then(response => response.text())
                    .then(data => {
                        // Process CSV data
                        let rows = data.split('\n');
                        
                        rows.forEach(row => {
                            const columns = row.split(',');
                            if (columns.length === 5) {
                                const time = columns[0];
                                const pair = columns[1];
                                const type = columns[2];
                                const price = parseFloat(columns[3]);
                                const quantity = parseFloat(columns[4]);
                            
                                if (!isNaN(price) && !isNaN(quantity)) {
                                    const key = `${type}-${price}-${quantity}`;
                                    if (!addedEntries.has(key)) {
                                        addedEntries.add(key);
                                        if (type === 'bid') {
                                            if (!bidsData[price]) {
                                                bidsData[price] = 0;
                                            }
                                            bidsData[price] += quantity;
                                            totalBids += quantity;
                                        } else if (type === 'ask') {
                                            if (!asksData[price]) {
                                                asksData[price] = 0;
                                            }
                                            asksData[price] += quantity;
                                            totalAsks += quantity;
                                        }
                                        if (!labels.includes(price)) {
                                            labels.push(price);
                                        }
                                    }
                                }
                            }
                        });

                        // Sort x-axis label values
                        labels.sort((a, b) => a - b);

                        // Convert object to array to update to chart
                        const bidsChartData = labels.map(price => bidsData[price] || 0);
                        const asksChartData = labels.map(price => asksData[price] || 0);

                        // Update data for chart
                        bidsChart.data.labels = labels; // Use price as x-axis label
                        bidsChart.data.datasets[0].data = bidsChartData;
                        bidsChart.data.datasets[1].data = asksChartData;
                        myPieChart.data.datasets[0].data = [totalAsks, totalBids];

                        // Update chart
                        bidsChart.update();
                        myPieChart.update();
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            }

          // Load data and update initial chart
                loadDataAndVisualize();

                // Update data every 5 seconds
                setInterval(loadDataAndVisualize, 10000); // Update every 5 seconds

            // function saveChartAsImage(chart, filename) {
            //     const link = document.createElement('a');
            //     link.href = chart.toBase64Image();
            //     link.download = filename;
            //     link.click();
            // }

            // document.getElementById('savePieChart').addEventListener('click', function() {
            //     saveChartAsImage(myPieChart, 'pie_chart.png');
            // });
            
            // document.getElementById('saveBidsChart').addEventListener('click', function() {
            //     saveChartAsImage(bidsChart, 'bids_chart.png');
            // });
        });
    </script>
</body>
</html>
